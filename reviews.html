<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Up Front Auto Repair ‚Äî Review Tool</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --bg: #0f1117;
    --surface: #1a1d27;
    --surface2: #22263a;
    --border: #2e3250;
    --text: #e8eaf6;
    --muted: #7b80a8;
    --red: #e53935;
    --red2: #ff6b6b;
    --green: #00c853;
    --yellow: #ffb300;
    --accent: #5c6bc0;
  }

  body {
    font-family: 'Inter', sans-serif;
    background: var(--bg);
    color: var(--text);
    display: flex;
    min-height: 100vh;
    overflow: hidden;
  }

  /* SIDEBAR */
  .sidebar {
    width: 64px;
    background: var(--surface);
    border-right: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 20px 0;
    gap: 8px;
    position: fixed;
    top: 0; left: 0; bottom: 0;
    z-index: 100;
  }

  .sidebar-logo {
    font-size: 24px;
    margin-bottom: 16px;
  }

  .nav-btn {
    width: 44px;
    height: 44px;
    border-radius: 12px;
    border: none;
    background: transparent;
    color: var(--muted);
    font-size: 20px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
    position: relative;
  }
  .nav-btn:hover { background: var(--surface2); color: var(--text); }
  .nav-btn.active { background: linear-gradient(135deg, var(--red), #c62828); color: white; box-shadow: 0 4px 15px rgba(229,57,53,0.4); }

  /* MAIN */
  .main {
    margin-left: 64px;
    flex: 1;
    display: flex;
    flex-direction: column;
    height: 100vh;
    overflow: hidden;
  }

  /* HEADER */
  .header {
    padding: 16px 24px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: var(--surface);
    flex-shrink: 0;
  }

  .header-title { font-size: 15px; font-weight: 600; }
  .header-sub { font-size: 12px; color: var(--muted); margin-top: 2px; }

  .header-right { display: flex; align-items: center; gap: 16px; }

  .clock { font-size: 13px; color: var(--muted); font-variant-numeric: tabular-nums; }

  .status-dot {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 12px;
    font-weight: 500;
  }
  .status-dot .dot {
    width: 8px; height: 8px;
    border-radius: 50%;
    background: var(--green);
    box-shadow: 0 0 6px var(--green);
    animation: pulse 2s infinite;
  }
  .status-dot .dot.red { background: var(--red); box-shadow: 0 0 6px var(--red); }

  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
  }

  /* SETUP BANNER */
  .setup-banner {
    background: linear-gradient(135deg, #7b3f00, #5d2e00);
    border-bottom: 1px solid #ff8f00;
    padding: 12px 24px;
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
    flex-shrink: 0;
  }
  .setup-banner:hover { background: linear-gradient(135deg, #8f4700, #6d3500); }
  .setup-banner.hidden { display: none; }

  /* CONTENT */
  .content {
    flex: 1;
    overflow-y: auto;
    padding: 24px;
  }

  .panel { display: none; }
  .panel.active { display: block; }

  /* SEND PANEL */
  .send-card {
    max-width: 520px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 20px;
    padding: 32px;
  }

  .send-card h2 { font-size: 20px; font-weight: 700; margin-bottom: 6px; }
  .send-card p { font-size: 13px; color: var(--muted); margin-bottom: 28px; }

  .form-group {
    position: relative;
    margin-bottom: 20px;
  }

  .form-group input, .form-group select {
    width: 100%;
    background: var(--surface2);
    border: 1.5px solid var(--border);
    border-radius: 12px;
    padding: 20px 16px 8px;
    font-size: 15px;
    font-family: 'Inter', sans-serif;
    color: var(--text);
    outline: none;
    transition: border-color 0.2s;
    appearance: none;
  }

  .form-group input:focus, .form-group select:focus {
    border-color: var(--red);
  }

  .form-group label {
    position: absolute;
    top: 14px; left: 16px;
    font-size: 13px;
    color: var(--muted);
    pointer-events: none;
    transition: all 0.2s;
    font-weight: 500;
  }

  .form-group input:focus + label,
  .form-group input:not(:placeholder-shown) + label,
  .form-group select + label {
    top: 6px;
    font-size: 10px;
    color: var(--red2);
    letter-spacing: 0.5px;
    text-transform: uppercase;
  }

  .form-group input::placeholder { color: transparent; }

  .send-btn {
    width: 100%;
    padding: 16px;
    background: linear-gradient(135deg, var(--red), #c62828);
    border: none;
    border-radius: 12px;
    color: white;
    font-size: 15px;
    font-weight: 700;
    font-family: 'Inter', sans-serif;
    cursor: pointer;
    transition: all 0.2s;
    box-shadow: 0 4px 20px rgba(229,57,53,0.4);
    letter-spacing: 0.3px;
    margin-top: 8px;
  }
  .send-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 30px rgba(229,57,53,0.5); }
  .send-btn:active { transform: translateY(0); }
  .send-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

  /* DASHBOARD */
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 16px;
    margin-bottom: 28px;
  }

  .stat-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 20px;
  }
  .stat-label { font-size: 12px; color: var(--muted); font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; }
  .stat-value { font-size: 32px; font-weight: 800; line-height: 1; }
  .stat-value.red { color: var(--red2); }
  .stat-value.green { color: var(--green); }
  .stat-value.yellow { color: var(--yellow); }
  .stat-value.blue { color: #7986cb; }

  .table-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    overflow: hidden;
    margin-bottom: 24px;
  }

  .table-header {
    padding: 16px 20px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
  }
  .table-header h3 { font-size: 14px; font-weight: 600; }

  .filter-btns { display: flex; gap: 6px; }
  .filter-btn {
    padding: 4px 12px;
    border-radius: 20px;
    border: 1px solid var(--border);
    background: transparent;
    color: var(--muted);
    font-size: 12px;
    font-family: 'Inter', sans-serif;
    cursor: pointer;
    transition: all 0.2s;
  }
  .filter-btn.active { background: var(--red); border-color: var(--red); color: white; }

  table { width: 100%; border-collapse: collapse; }
  th { padding: 10px 16px; text-align: left; font-size: 11px; font-weight: 600; color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 1px solid var(--border); }
  td { padding: 12px 16px; font-size: 13px; border-bottom: 1px solid rgba(46,50,80,0.5); }
  tr:last-child td { border-bottom: none; }
  tr { transition: background 0.15s; }
  tr:hover td { background: rgba(255,255,255,0.02); }

  .badge {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 3px 10px;
    border-radius: 20px;
    font-size: 11px;
    font-weight: 600;
  }
  .badge.pending { background: rgba(255,179,0,0.15); color: var(--yellow); }
  .badge.followed_up { background: rgba(92,107,192,0.15); color: #7986cb; }
  .badge.reviewed { background: rgba(0,200,83,0.15); color: var(--green); }
  .badge.no_response { background: rgba(120,120,140,0.15); color: #7b80a8; }

  .action-btns { display: flex; gap: 6px; }
  .action-btn {
    padding: 4px 10px;
    border-radius: 8px;
    border: 1px solid var(--border);
    background: transparent;
    color: var(--muted);
    font-size: 11px;
    font-family: 'Inter', sans-serif;
    cursor: pointer;
    transition: all 0.2s;
  }
  .action-btn:hover { border-color: var(--text); color: var(--text); }
  .action-btn.mark-reviewed:hover { border-color: var(--green); color: var(--green); }
  .action-btn.delete-btn:hover { border-color: var(--red); color: var(--red); }

  .empty-state {
    padding: 48px;
    text-align: center;
    color: var(--muted);
  }
  .empty-state .emoji { font-size: 40px; margin-bottom: 12px; }
  .empty-state p { font-size: 14px; }

  /* SETTINGS */
  .settings-card {
    max-width: 560px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 20px;
    padding: 32px;
    margin-bottom: 20px;
  }
  .settings-card h2 { font-size: 18px; font-weight: 700; margin-bottom: 6px; }
  .settings-card .desc { font-size: 13px; color: var(--muted); margin-bottom: 24px; }

  .setup-steps {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 16px 20px;
    margin-bottom: 24px;
  }
  .setup-steps h4 { font-size: 12px; font-weight: 600; color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 10px; }
  .setup-steps ol { padding-left: 18px; }
  .setup-steps li { font-size: 13px; color: var(--text); margin-bottom: 6px; line-height: 1.5; }
  .setup-steps a { color: var(--red2); text-decoration: none; }
  .setup-steps a:hover { text-decoration: underline; }

  .settings-input {
    width: 100%;
    background: var(--surface2);
    border: 1.5px solid var(--border);
    border-radius: 12px;
    padding: 14px 16px;
    font-size: 14px;
    font-family: 'Inter', sans-serif;
    color: var(--text);
    outline: none;
    margin-bottom: 12px;
    transition: border-color 0.2s;
  }
  .settings-input:focus { border-color: var(--red); }
  .settings-input::placeholder { color: var(--muted); }

  .settings-label {
    font-size: 12px;
    font-weight: 600;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 6px;
    display: block;
  }

  .settings-row { margin-bottom: 20px; }

  .btn-row { display: flex; gap: 10px; margin-top: 8px; }

  .btn-save {
    flex: 1;
    padding: 13px;
    background: linear-gradient(135deg, var(--red), #c62828);
    border: none;
    border-radius: 10px;
    color: white;
    font-size: 14px;
    font-weight: 700;
    font-family: 'Inter', sans-serif;
    cursor: pointer;
    transition: all 0.2s;
    box-shadow: 0 4px 15px rgba(229,57,53,0.3);
  }
  .btn-save:hover { transform: translateY(-1px); }

  .btn-test {
    padding: 13px 20px;
    background: var(--surface2);
    border: 1.5px solid var(--border);
    border-radius: 10px;
    color: var(--text);
    font-size: 14px;
    font-weight: 600;
    font-family: 'Inter', sans-serif;
    cursor: pointer;
    transition: all 0.2s;
  }
  .btn-test:hover { border-color: var(--accent); color: var(--accent); }

  .danger-zone {
    background: rgba(229,57,53,0.05);
    border: 1px solid rgba(229,57,53,0.2);
    border-radius: 12px;
    padding: 16px 20px;
    margin-top: 20px;
  }
  .danger-zone h4 { font-size: 13px; font-weight: 600; color: var(--red2); margin-bottom: 8px; }
  .danger-zone p { font-size: 12px; color: var(--muted); margin-bottom: 12px; }
  .btn-danger {
    padding: 8px 16px;
    background: transparent;
    border: 1px solid var(--red);
    border-radius: 8px;
    color: var(--red2);
    font-size: 12px;
    font-weight: 600;
    font-family: 'Inter', sans-serif;
    cursor: pointer;
    transition: all 0.2s;
  }
  .btn-danger:hover { background: rgba(229,57,53,0.1); }

  /* TOAST */
  .toast-container {
    position: fixed;
    bottom: 24px;
    right: 24px;
    z-index: 9999;
    display: flex;
    flex-direction: column;
    gap: 10px;
  }
  .toast {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 14px 18px;
    font-size: 13px;
    font-weight: 500;
    box-shadow: 0 8px 30px rgba(0,0,0,0.4);
    display: flex;
    align-items: center;
    gap: 10px;
    animation: slideIn 0.3s ease;
    max-width: 320px;
  }
  .toast.success { border-color: rgba(0,200,83,0.4); }
  .toast.error { border-color: rgba(229,57,53,0.4); }
  @keyframes slideIn {
    from { transform: translateX(120%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
  }

  /* CONFETTI */
  .confetti-piece {
    position: fixed;
    width: 8px;
    height: 8px;
    border-radius: 2px;
    animation: confettiFall linear forwards;
    z-index: 9998;
    pointer-events: none;
  }
  @keyframes confettiFall {
    0% { transform: translateY(-20px) rotate(0deg); opacity: 1; }
    100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
  }

  /* MODAL */
  .modal-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.6);
    z-index: 500;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(4px);
  }
  .modal-overlay.open { display: flex; }
  .modal {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 20px;
    padding: 28px;
    max-width: 420px;
    width: 90%;
  }
  .modal h3 { font-size: 17px; font-weight: 700; margin-bottom: 8px; }
  .modal p { font-size: 13px; color: var(--muted); margin-bottom: 20px; }
  .modal-btns { display: flex; gap: 10px; justify-content: flex-end; }
  .btn-cancel {
    padding: 10px 18px;
    background: transparent;
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--muted);
    font-family: 'Inter', sans-serif;
    font-size: 13px;
    cursor: pointer;
  }
  .btn-confirm {
    padding: 10px 18px;
    background: var(--red);
    border: none;
    border-radius: 8px;
    color: white;
    font-family: 'Inter', sans-serif;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
  }

  /* Scrollbar */
  ::-webkit-scrollbar { width: 6px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

  /* Mobile tweaks */
  @media (max-width: 600px) {
    .sidebar { width: 52px; }
    .main { margin-left: 52px; }
    .content { padding: 16px; }
    .send-card, .settings-card { padding: 20px; }
    .stats-grid { grid-template-columns: 1fr 1fr; }
    th:nth-child(3), td:nth-child(3),
    th:nth-child(4), td:nth-child(4) { display: none; }
  }
</style>
</head>
<body>

<!-- SIDEBAR -->
<nav class="sidebar">
  <div class="sidebar-logo">üîß</div>
  <button class="nav-btn active" id="nav-send" onclick="showPanel('send')" title="Send Review">üì§</button>
  <button class="nav-btn" id="nav-dashboard" onclick="showPanel('dashboard')" title="Dashboard">üìä</button>
  <button class="nav-btn" id="nav-settings" onclick="showPanel('settings')" title="Settings">‚öôÔ∏è</button>
</nav>

<!-- MAIN -->
<div class="main">

  <!-- HEADER -->
  <div class="header">
    <div>
      <div class="header-title">Up Front Auto Repair</div>
      <div class="header-sub">Review Request Tool</div>
    </div>
    <div class="header-right">
      <span class="clock" id="clock">--:-- --</span>
      <span class="status-dot" id="status-dot">
        <span class="dot red" id="status-indicator"></span>
        <span id="status-text">Setup Required</span>
      </span>
    </div>
  </div>

  <!-- SETUP BANNER -->
  <div class="setup-banner" id="setup-banner" onclick="showPanel('settings')">
    <span>‚ö†Ô∏è</span>
    <span><strong>Setup Required</strong> ‚Äî Click ‚öôÔ∏è Settings to add your Twilio credentials before sending reviews</span>
  </div>

  <!-- CONTENT -->
  <div class="content">

    <!-- SEND PANEL -->
    <div class="panel active" id="panel-send">
      <div class="send-card">
        <h2>üì§ Send Review Request</h2>
        <p>Text a customer their Google review link after service.</p>

        <form id="send-form" onsubmit="handleSend(event)">
          <div class="form-group">
            <input type="text" id="customer-name" placeholder="Name" required autocomplete="off">
            <label for="customer-name">Customer Name</label>
          </div>
          <div class="form-group">
            <input type="tel" id="customer-phone" placeholder="Phone" required autocomplete="off" oninput="formatPhone(this)">
            <label for="customer-phone">Phone Number</label>
          </div>
          <div class="form-group">
            <input type="text" id="customer-service" placeholder="Service" required autocomplete="off">
            <label for="customer-service">Service Performed</label>
          </div>
          <button type="submit" class="send-btn" id="send-btn">
            üöÄ Send Review Request
          </button>
        </form>
      </div>
    </div>

    <!-- DASHBOARD PANEL -->
    <div class="panel" id="panel-dashboard">
      <div class="stats-grid" id="stats-grid"></div>

      <div class="table-card">
        <div class="table-header">
          <h3>Customers</h3>
          <div class="filter-btns">
            <button class="filter-btn active" onclick="setFilter('all', this)">All</button>
            <button class="filter-btn" onclick="setFilter('pending', this)">Pending</button>
            <button class="filter-btn" onclick="setFilter('reviewed', this)">Reviewed</button>
          </div>
        </div>
        <div id="table-container"></div>
      </div>
    </div>

    <!-- SETTINGS PANEL -->
    <div class="panel" id="panel-settings">
      <div class="settings-card">
        <h2>‚öôÔ∏è Twilio Configuration</h2>
        <p class="desc">Connect Twilio to send SMS review requests from any device, anywhere.</p>

        <div class="setup-steps">
          <h4>üìã Quick Setup Guide</h4>
          <ol>
            <li>Go to <a href="https://twilio.com" target="_blank">twilio.com</a> and sign up (free trial)</li>
            <li>Get a phone number ‚Äî $1/month after trial period</li>
            <li>From the Console Dashboard, copy your <strong>Account SID</strong> and <strong>Auth Token</strong></li>
            <li>Paste them below and click Save</li>
          </ol>
        </div>

        <div class="settings-row">
          <label class="settings-label">Account SID</label>
          <input class="settings-input" id="s-sid" type="text" placeholder="ACxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx">
        </div>
        <div class="settings-row">
          <label class="settings-label">Auth Token</label>
          <input class="settings-input" id="s-token" type="password" placeholder="Your Auth Token (keep secret)">
        </div>
        <div class="settings-row">
          <label class="settings-label">Your Twilio Phone Number</label>
          <input class="settings-input" id="s-from" type="text" placeholder="+12075551234">
        </div>

        <div class="btn-row">
          <button class="btn-save" onclick="saveSettings()">üíæ Save Credentials</button>
          <button class="btn-test" onclick="openTestModal()">üì± Send Test SMS</button>
        </div>

        <div class="danger-zone">
          <h4>‚ö†Ô∏è Danger Zone</h4>
          <p>Clear all customer data from this browser. This cannot be undone.</p>
          <button class="btn-danger" onclick="clearAllData()">üóë Clear All Customer Data</button>
        </div>
      </div>
    </div>

  </div><!-- /content -->
</div><!-- /main -->

<!-- TOAST CONTAINER -->
<div class="toast-container" id="toasts"></div>

<!-- TEST MODAL -->
<div class="modal-overlay" id="test-modal">
  <div class="modal">
    <h3>üì± Send Test SMS</h3>
    <p>Enter a phone number to receive a test message confirming Twilio is working.</p>
    <input class="settings-input" id="test-phone" type="tel" placeholder="(207) 555-1234" oninput="formatPhone(this)">
    <div class="modal-btns">
      <button class="btn-cancel" onclick="closeModal('test-modal')">Cancel</button>
      <button class="btn-confirm" onclick="sendTest()">Send Test</button>
    </div>
  </div>
</div>

<!-- CLEAR DATA MODAL -->
<div class="modal-overlay" id="clear-modal">
  <div class="modal">
    <h3>‚ö†Ô∏è Clear All Data?</h3>
    <p>This will permanently delete all customer records from this browser. Twilio credentials will be kept.</p>
    <div class="modal-btns">
      <button class="btn-cancel" onclick="closeModal('clear-modal')">Cancel</button>
      <button class="btn-confirm" onclick="confirmClearData()">Yes, Delete All</button>
    </div>
  </div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STORAGE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function getCustomers() {
  return JSON.parse(localStorage.getItem('customers') || '[]');
}

function saveCustomers(customers) {
  localStorage.setItem('customers', JSON.stringify(customers));
}

function getTwilio() {
  return {
    sid: localStorage.getItem('twilio_sid') || '',
    token: localStorage.getItem('twilio_token') || '',
    from: localStorage.getItem('twilio_from') || ''
  };
}

function isTwilioConfigured() {
  const { sid, token, from } = getTwilio();
  return sid && token && from;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TWILIO SMS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

async function sendSMS(to, message) {
  const { sid, token, from } = getTwilio();
  if (!sid || !token || !from) return { ok: false, error: 'Twilio not configured' };

  const rawPhone = to.replace(/\D/g, '');
  const formatted = rawPhone.length === 10 ? '+1' + rawPhone : '+' + rawPhone;

  const url = `https://api.twilio.com/2010-04-01/Accounts/${sid}/Messages.json`;
  const auth = btoa(`${sid}:${token}`);
  const body = new URLSearchParams({ To: formatted, From: from, Body: message });

  try {
    const resp = await fetch(url, {
      method: 'POST',
      headers: {
        'Authorization': `Basic ${auth}`,
        'Content-Type': 'application/x-www-form-urlencoded'
      },
      body
    });
    const data = await resp.json();
    if (!resp.ok) {
      return { ok: false, error: data.message || 'Twilio error' };
    }
    return { ok: true };
  } catch (e) {
    return { ok: false, error: e.message };
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MESSAGES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function firstMsg(name, service) {
  return `Hi ${name}! Thanks for choosing Up Front Auto Repair for your ${service}. We'd love a quick Google review ‚Äî it really helps our small shop: https://g.page/r/CXq8b_a9JviMEAE/review üôè - Up Front Auto Repair (207) 648-4747`;
}

function followUpMsg(name) {
  return `Hi ${name}! Just a friendly follow-up from Up Front Auto Repair. If you have a moment, your Google review means a lot to us: https://g.page/r/CXq8b_a9JviMEAE/review Thanks! - (207) 648-4747`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AUTO FOLLOW-UP (runs on load)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

async function runFollowUps() {
  if (!isTwilioConfigured()) return;
  const customers = getCustomers();
  const now = Date.now();
  const FORTY_EIGHT = 48 * 60 * 60 * 1000;
  let updated = false;

  for (const c of customers) {
    if (c.status === 'pending' && !c.followUpSent) {
      const age = now - new Date(c.sentAt).getTime();
      if (age >= FORTY_EIGHT) {
        const result = await sendSMS(c.phone, followUpMsg(c.name));
        if (result.ok) {
          c.followUpSent = true;
          c.status = 'followed_up';
          c.followUpAt = new Date().toISOString();
          updated = true;
          console.log(`Follow-up sent to ${c.name}`);
        }
      }
    }
  }

  if (updated) {
    saveCustomers(customers);
    renderDashboard();
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SEND FORM
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

async function handleSend(e) {
  e.preventDefault();
  if (!isTwilioConfigured()) {
    toast('‚öôÔ∏è Please configure Twilio in Settings first.', 'error');
    showPanel('settings');
    return;
  }

  const name = document.getElementById('customer-name').value.trim();
  const phone = document.getElementById('customer-phone').value.trim();
  const service = document.getElementById('customer-service').value.trim();

  const btn = document.getElementById('send-btn');
  btn.disabled = true;
  btn.textContent = '‚è≥ Sending...';

  const result = await sendSMS(phone, firstMsg(name, service));

  if (result.ok) {
    // Save to localStorage
    const customers = getCustomers();
    customers.unshift({
      id: Date.now(),
      name, phone, service,
      sentAt: new Date().toISOString(),
      status: 'pending',
      followUpSent: false,
      followUpAt: null,
      reviewedAt: null
    });
    saveCustomers(customers);

    toast(`‚úÖ Review request sent to ${name}!`, 'success');
    confetti();
    document.getElementById('send-form').reset();
  } else {
    toast(`‚ùå Failed to send: ${result.error}`, 'error');
  }

  btn.disabled = false;
  btn.textContent = 'üöÄ Send Review Request';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DASHBOARD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

let currentFilter = 'all';

function setFilter(f, btn) {
  currentFilter = f;
  document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  renderTable();
}

function renderDashboard() {
  const customers = getCustomers();
  const total = customers.length;
  const reviewed = customers.filter(c => c.status === 'reviewed').length;
  const pending = customers.filter(c => c.status === 'pending').length;
  const followedUp = customers.filter(c => c.status === 'followed_up').length;

  const statsEl = document.getElementById('stats-grid');
  statsEl.innerHTML = `
    <div class="stat-card">
      <div class="stat-label">Total Sent</div>
      <div class="stat-value blue" data-target="${total}">0</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Reviewed ‚≠ê</div>
      <div class="stat-value green" data-target="${reviewed}">0</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Pending</div>
      <div class="stat-value yellow" data-target="${pending}">0</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Followed Up</div>
      <div class="stat-value red" data-target="${followedUp}">0</div>
    </div>
  `;

  // Count-up animation
  statsEl.querySelectorAll('[data-target]').forEach(el => {
    const target = parseInt(el.dataset.target);
    if (target === 0) return;
    let current = 0;
    const step = Math.ceil(target / 20);
    const interval = setInterval(() => {
      current = Math.min(current + step, target);
      el.textContent = current;
      if (current >= target) clearInterval(interval);
    }, 40);
  });

  renderTable();
}

function renderTable() {
  const customers = getCustomers();
  const filtered = currentFilter === 'all' ? customers : customers.filter(c => c.status === currentFilter);
  const container = document.getElementById('table-container');

  if (filtered.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <div class="emoji">üì≠</div>
        <p>${currentFilter === 'all' ? 'No customers yet. Send your first review request!' : 'No customers in this category.'}</p>
      </div>`;
    return;
  }

  const rows = filtered.map(c => {
    const date = new Date(c.sentAt).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    return `
      <tr>
        <td><strong>${esc(c.name)}</strong></td>
        <td>${esc(c.phone)}</td>
        <td>${esc(c.service)}</td>
        <td>${date}</td>
        <td><span class="badge ${c.status}">${statusLabel(c.status)}</span></td>
        <td>
          <div class="action-btns">
            ${c.status !== 'reviewed' ? `<button class="action-btn mark-reviewed" onclick="markReviewed(${c.id})">‚úì Reviewed</button>` : ''}
            <button class="action-btn delete-btn" onclick="deleteCustomer(${c.id})">‚úï</button>
          </div>
        </td>
      </tr>`;
  }).join('');

  container.innerHTML = `
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Phone</th>
          <th>Service</th>
          <th>Date</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>${rows}</tbody>
    </table>`;
}

function statusLabel(s) {
  return { pending: '‚è≥ Pending', followed_up: 'üì© Followed Up', reviewed: '‚≠ê Reviewed', no_response: 'üò∂ No Response' }[s] || s;
}

function markReviewed(id) {
  const customers = getCustomers();
  const c = customers.find(x => x.id === id);
  if (c) { c.status = 'reviewed'; c.reviewedAt = new Date().toISOString(); }
  saveCustomers(customers);
  renderDashboard();
  toast('‚≠ê Marked as reviewed!', 'success');
}

function deleteCustomer(id) {
  const customers = getCustomers().filter(x => x.id !== id);
  saveCustomers(customers);
  renderDashboard();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SETTINGS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function loadSettings() {
  const { sid, token, from } = getTwilio();
  document.getElementById('s-sid').value = sid;
  document.getElementById('s-token').value = token;
  document.getElementById('s-from').value = from;
}

function saveSettings() {
  const sid = document.getElementById('s-sid').value.trim();
  const token = document.getElementById('s-token').value.trim();
  const from = document.getElementById('s-from').value.trim();

  if (!sid || !token || !from) {
    toast('‚ö†Ô∏è Please fill in all three fields.', 'error');
    return;
  }

  localStorage.setItem('twilio_sid', sid);
  localStorage.setItem('twilio_token', token);
  localStorage.setItem('twilio_from', from);

  updateStatusDot();
  toast('‚úÖ Credentials saved!', 'success');
}

function openTestModal() {
  if (!isTwilioConfigured()) {
    toast('‚ö†Ô∏è Save your credentials first.', 'error');
    return;
  }
  document.getElementById('test-modal').classList.add('open');
}

async function sendTest() {
  const phone = document.getElementById('test-phone').value.trim();
  if (!phone) { toast('Enter a phone number.', 'error'); return; }
  closeModal('test-modal');
  toast('üì§ Sending test SMS...', 'success');
  const result = await sendSMS(phone, '‚úÖ Test from Up Front Auto Repair review tool ‚Äî Twilio is working!');
  if (result.ok) {
    toast('‚úÖ Test SMS sent!', 'success');
  } else {
    toast(`‚ùå Test failed: ${result.error}`, 'error');
  }
}

function clearAllData() {
  document.getElementById('clear-modal').classList.add('open');
}

function confirmClearData() {
  localStorage.removeItem('customers');
  closeModal('clear-modal');
  renderDashboard();
  toast('üóë All customer data cleared.', 'success');
}

function closeModal(id) {
  document.getElementById(id).classList.remove('open');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// UI HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function showPanel(name) {
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('panel-' + name).classList.add('active');
  document.getElementById('nav-' + name).classList.add('active');
  if (name === 'dashboard') renderDashboard();
  if (name === 'settings') loadSettings();
}

function updateStatusDot() {
  const configured = isTwilioConfigured();
  const dot = document.getElementById('status-indicator');
  const text = document.getElementById('status-text');
  const banner = document.getElementById('setup-banner');
  dot.classList.toggle('red', !configured);
  text.textContent = configured ? 'Ready' : 'Setup Required';
  banner.classList.toggle('hidden', configured);
}

function formatPhone(input) {
  let val = input.value.replace(/\D/g, '');
  if (val.length >= 10) val = val.slice(0, 10);
  if (val.length >= 7) {
    input.value = `(${val.slice(0,3)}) ${val.slice(3,6)}-${val.slice(6)}`;
  } else if (val.length >= 4) {
    input.value = `(${val.slice(0,3)}) ${val.slice(3)}`;
  } else if (val.length > 0) {
    input.value = `(${val}`;
  }
}

function esc(str) {
  return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function toast(msg, type = 'success') {
  const container = document.getElementById('toasts');
  const el = document.createElement('div');
  el.className = `toast ${type}`;
  el.textContent = msg;
  container.appendChild(el);
  setTimeout(() => el.remove(), 4000);
}

function confetti() {
  const colors = ['#e53935','#ff6b6b','#ffb300','#00c853','#5c6bc0','#ffffff'];
  for (let i = 0; i < 60; i++) {
    const el = document.createElement('div');
    el.className = 'confetti-piece';
    el.style.cssText = `
      left: ${Math.random() * 100}vw;
      top: -10px;
      background: ${colors[Math.floor(Math.random() * colors.length)]};
      animation-duration: ${1.5 + Math.random() * 2}s;
      animation-delay: ${Math.random() * 0.5}s;
      transform: rotate(${Math.random() * 360}deg);
      width: ${6 + Math.random() * 8}px;
      height: ${6 + Math.random() * 8}px;
    `;
    document.body.appendChild(el);
    setTimeout(() => el.remove(), 4000);
  }
}

function startClock() {
  function tick() {
    const now = new Date();
    document.getElementById('clock').textContent = now.toLocaleTimeString('en-US', {
      hour: 'numeric', minute: '2-digit', second: '2-digit', hour12: true
    });
  }
  tick();
  setInterval(tick, 1000);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

document.addEventListener('DOMContentLoaded', () => {
  startClock();
  updateStatusDot();
  runFollowUps();
});

// Close modals on overlay click
document.querySelectorAll('.modal-overlay').forEach(overlay => {
  overlay.addEventListener('click', e => {
    if (e.target === overlay) overlay.classList.remove('open');
  });
});
</script>
</body>
</html>
